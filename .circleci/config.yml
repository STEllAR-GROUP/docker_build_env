version: 2
jobs:
  build:
    working_directory: ~/STEllAR-GROUP/docker_build_env
    parallelism: 1
    shell: /bin/bash --login
    environment:
      CIRCLE_ARTIFACTS: /tmp/circleci-artifacts
      CIRCLE_TEST_REPORTS: /tmp/circleci-test-results
      IMAGE_FOLDER_NAME: debian_clang_tmp
      IMAGE_NAME: stellargroup/build_env:debian_clang
    docker:
    - image: circleci/build-image:ubuntu-14.04-XXL-upstart-1189-5614f37
      command: /sbin/init
    steps:
    # Machine Setup
    - checkout
    - run: mkdir -p $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS
    - run:
        command: ' echo ${USER}  '
    - run:
        working_directory: ~/STEllAR-GROUP/docker_build_env
        command: 'sudo docker info >/dev/null 2>&1 || sudo service docker start; '
    - run: docker build -t ${IMAGE_NAME} ${IMAGE_FOLDER_NAME}
    - run: git clone https://github.com/STEllAR-GROUP/hpx.git --depth=1
    - run: docker --version
    - run: docker run ${IMAGE_NAME} printenv
    - run: docker run -v $PWD/hpx:/hpx -w /hpx ${IMAGE_NAME} mkdir build
    - run: docker run -v $PWD/hpx:/hpx -w /hpx/build ${IMAGE_NAME} cmake .. -DHPX_WITH_MALLOC=system
